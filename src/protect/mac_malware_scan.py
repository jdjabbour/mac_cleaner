import os
import subprocess
from pathlib import Path

# Common malware persistence locations
SCAN_PATHS = [
    Path.home() / "Library/LaunchAgents",
    Path("/Library/LaunchAgents"),
    Path("/Library/LaunchDaemons"),
    Path.home() / "Library/Application Support",
    Path("/Library/Application Support"),
    Path.home() / ".config",
]

# Known suspicious names (extendable)
SUSPICIOUS_KEYWORDS = [
    "mackeeper",
    "adload",
    "genieo",
    "vsearch",
    "installmac",
    "macos cleaner",
    "advanced mac cleaner",
    "launchdaemon",
    "com.apple.update",
    "helper",
]

KNOWN_BAD_PROCESSES = [
    "adload",
    "osx.generic",
    "macsweeper",
    "macdefender",
]

def run(cmd):
    return subprocess.run(cmd, capture_output=True, text=True).stdout.strip()

def check_gatekeeper(app_path):
    out = run(["spctl", "--assess", "--verbose=4", app_path])
    return "rejected" in out.lower()

def scan_launch_items():
    print("\nüîç Scanning Launch Agents & Daemons...")
    findings = []

    for path in SCAN_PATHS:
        if not path.exists():
            continue

        for item in path.rglob("*"):
            name = item.name.lower()
            for keyword in SUSPICIOUS_KEYWORDS:
                if keyword in name:
                    findings.append(item)

    return findings

def scan_running_processes():
    print("\nüîç Scanning running processes...")
    findings = []

    ps = run(["ps", "aux"])
    for proc in KNOWN_BAD_PROCESSES:
        if proc in ps.lower():
            findings.append(proc)

    return findings

def scan_unsigned_apps():
    print("\nüîç Scanning for unsigned applications...")
    findings = []

    apps_dirs = [Path("/Applications"), Path.home() / "Applications"]
    for base in apps_dirs:
        if not base.exists():
            continue

        for app in base.glob("*.app"):
            try:
                if check_gatekeeper(str(app)):
                    findings.append(app)
            except:
                pass

    return findings

def scan_cron_jobs():
    print("\nüîç Scanning cron jobs...")
    findings = []

    cron = run(["crontab", "-l"])
    if cron:
        findings.append("User crontab present")

    system_cron = Path("/etc/cron.d")
    if system_cron.exists():
        findings.append("System cron jobs found")

    return findings

def mac_malware_scan():
    print("üõ°Ô∏è macOS Malware Scan Starting...\n")

    launch_findings = scan_launch_items()
    proc_findings = scan_running_processes()
    unsigned_apps = scan_unsigned_apps()
    cron_findings = scan_cron_jobs()

    print("\n================ RESULTS ================")

    if launch_findings:
        print("\n‚ö†Ô∏è Suspicious persistence items:")
        for f in launch_findings:
            print(f" - {f}")
    else:
        print("\n‚úÖ No suspicious LaunchAgents or Daemons")

    if proc_findings:
        print("\n‚ö†Ô∏è Suspicious running processes:")
        for p in proc_findings:
            print(f" - {p}")
    else:
        print("\n‚úÖ No known malicious processes running")

    if unsigned_apps:
        print("\n‚ö†Ô∏è Unsigned or rejected apps:")
        for app in unsigned_apps:
            print(f" - {app}")
    else:
        print("\n‚úÖ All apps appear properly signed")

    if cron_findings:
        print("\n‚ö†Ô∏è Cron activity detected:")
        for c in cron_findings:
            print(f" - {c}")
    else:
        print("\n‚úÖ No suspicious cron jobs")

    print("\nüß† Scan complete.")
    print("No files were modified.")

if __name__ == "__main__":
    main()
